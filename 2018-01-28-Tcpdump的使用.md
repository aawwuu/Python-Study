tcpdump英文解释是dump traffic on a network，可以将网络中传送的数据包的报文头完全截获下来提供分析，它支持针对网络层、协议、主机、网络或端口的过滤，并提供and, or, not等逻辑语句来帮助用户去掉无用的信息。

可以将抓取的数据写入文件中，一种方法是通过-w选项：

```
# tcpdump -w rawfile
```

通过-r读取：

```
# tcpdump -r rawfile > text file
```

另一种方法是通过-l选项和tee命令实现：

```
# tcpdump -l | tee outfile
```

### tcpdump的选项

tcpdump选项可划分为四大类型：控制tcpdump程序行为，控制数据怎样显示，控制显示什么数据，以及过滤命令。

#### 控制tcpdump程序行为

-w	将抓取数据输出到文件，通过-r读取

-c	指定抓取报文数量的上限

```
# tcpdump -c100
```

-i	指定抓取的网卡接口的数据，默认为最低编号接口

```
# tcpdump -i eth0
```

-p	将网卡接口设置为非混杂模式

-s	控制单个报文的截取长度。默认长度是262144 bytes

```
# tcpdump -s200
```

#### 控制数据怎样显示

-a, -n, -N, -f 选项决定地址信息如何显示。

-a	将网络地址转换为名称，tcpdump默认使用-a选项

-n	不将网络地址转换成名称

-N	不进行域名转换，例如会输出"nic"而不是"nic.ddn.mil"

-f	不对远端域名解析

在/etc/hosts文件中添加一行 `61.135.169.125 www.baidu.com`

在主机 ld 执行`ping www.baidu.com`

分别使用-a, -n, -N, -f

```shell
# tcpdump host 61.135.169.125 -c1 -a
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
21:03:18.519761 IP ld > www.baidu.com: ICMP echo request, id 5172, seq 105, length 64

# tcpdump host 61.135.169.125 -c1 -n
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
21:03:21.524229 IP 192.168.1.4 > 61.135.169.125: ICMP echo request, id 5172, seq 108, length 64

# tcpdump host 61.135.169.125 -c1 -N
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
21:03:24.529429 IP ld > www: ICMP echo request, id 5172, seq 111, length 64

# tcpdump host 61.135.169.125 -c1 -f
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
21:03:27.535282 IP ld > 61.135.169.125: ICMP echo request, id 5172, seq 114, length 64
```

-t和-tt控制时间的显示

默认显示标准格式时间，如 “21:03:27.535282”

-t	不显示时间

-tt	显示时间戳

```shell
# tcpdump host www.baidu.com -c1 -tt
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
1517147525.018036 IP ld > 61.135.169.121: ICMP echo request, id 5764, seq 38, length 64

# sudo tcpdump host www.baidu.com -c1 -t
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
IP ld > 61.135.169.121: ICMP echo request, id 5764, seq 42, length 64
```

#### 控制显示什么数据

-v, -vv, -vvv 	显示更详细的信息，例如 ttl 时间

-q	显示剪短的信息

-e	输出链路层信息，可以看到mac地址

```
# tcpdump host www.baidu.com -c1 -e
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
22:01:17.281369 50:7b:9d:85:b8:56 (oui Unknown) > c4:a3:66:2d:59:4c (oui Unknown), ethertype IPv4 (0x0800), length 98: ld > 61.135.169.125: ICMP echo request, id 5866, seq 1, length 64
```

注意到这里的oui Unknown，oui指的是Organizationally unique identifier，意思是组织唯一标识符，即网卡的制造厂商，一般mac地址的前三个字节是oui

-x	将报文以十六进制显示

```
# tcpdump host www.baidu.com -c1 -xvv
tcpdump: listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
22:10:22.243511 IP (tos 0x0, ttl 64, id 30756, offset 0, flags [DF], proto ICMP (1), length 84)
    ld > 61.135.169.125: ICMP echo request, id 5978, seq 16, length 64
	0x0000:  4500 0054 7824 4000 4001 19d4 c0a8 0104
	0x0010:  3d87 a97d 0800 bed7 175a 0010 ced9 6d5a
	0x0020:  0000 0000 23b7 0300 0000 0000 1011 1213
	0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223
	0x0040:  2425 2627 2829 2a2b 2c2d 2e2f 3031 3233
	0x0050:  3435 3637
```

#### 过滤

tcpdump通过关键字对获取的数据进行过滤，如果过滤的规则很复杂，可以使用-F选项将过滤规则放在文件中。例如在filter文件中写入`host 172.8.1.2` ，那么

```
# tcpdump -F filter
```

等价于

```
# tcpdump host 12.8.1.2
```

**地址过滤**

host指定过滤主机，例如

```
# tcpdump host 12.8.1.2
```

也可以指定mac地址

```
# tcpdump ether host c4:a3:66:2d:59:4c
```

用src或dst指定数据的方向

```
# tcpdump src host www.qq.com
```

使用broadcast和multicast指定广播和多播

使用net指定网络地址

```
# tcpdump net 172.8.1
# tcpdump net 172.8.1.0 mas 255.255.255.0
```

**端口和协议过滤**

端口和协议过滤有三种形式：关键字，协议(通过proto指定)，端口(通过port指定)

关键字包括ip, igmp, tcp, udp,  icmp

```
# tcpdump udp
```

传输层的协议，使用proto或ip proto 后加协议名称或编号过滤

协议名称和编号的对应关系在`/etc/protocols`中

```
# tcpdump ip proto vrrp
# tcpdump ip proto 112
```

注意proto后不能跟tcpdump的关键字ip, igmp, tcp, udp,  icmp，但是可以跟他们的协议编号

```bash
# tcpdump proto tcp
tcpdump: syntax error in filter expression: syntax error
```

```bash
# tcpdump proto 6
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on enp2s0, link-type EN10MB (Ethernet), capture size 262144 bytes
22:54:44.955777 IP ld.43374 > 61.135.169.125.https: Flags [F.], seq 47100145, ack 1367558548, win 237, length 0
```

对于高层级协议，使用port过滤，可以指定协议名称或端口号

协议和端口的对应关系在`/etc/services`中

```
# tcpdump udp port domain
# tcpdump udp port 53
```

以上过滤都可以使用 `and, or, not和（）`进行条件组合

还可以过滤报文的长度和字段内容，结合运算符，进行更精确地过滤，例如：

```
# tcpdump greater 300 and host www.baidu.com
```



对报文内容过滤比较复杂，需要理解报文头的结构。

一般使用语法 proto [ expr : size ]。字段proto指定要查看的报文头——ip则查看IP头，tcp则查看TCP头，以此类推。expr字段给出从报文头索引0开始的位移。即：报文头的第一个字节为0，第二字节为1，以此类推。size字段是可选的，指定需要使用的字节数，1，2或4。

```
# tcpdump 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)'
```

To print all IPv4 HTTP packets to and from port 80, i.e. print only packets that contain data, not, for example, SYN and FIN packets and ACK-only packets. (IPv6 is left as an exercise for the reader.)
